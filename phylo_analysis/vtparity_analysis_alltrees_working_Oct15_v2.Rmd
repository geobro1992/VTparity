---
title: "VT Parity"
output: html_notebook
---

Initial packages

```{r}
#rm(list=ls(all=TRUE))
library(ape)
library(treeplyr)
library(rotl)
library(castor)
library(geiger)
library(phytools)
library(phylolm)
dat <- read.csv("../datasets/vtparity.csv")
getwd()
```

I. Tree Generation - Can Skip to II and just load synthesis td.
```{r eval=FALSE}
amphib <- drop.tip(read.tree("../trees/amph_shl_new_Consensus_7238.tre"), "Homo_sapiens") #Jetz & Pyron 2018
birds <- read.tree("../trees/bird.tre") #Jetz 
squam <- read.tree("../trees/squam_shl_new_Consensus_9755.tre") #Tonini
mamm <- read.tree("../trees/Completed_5911sp_topoCons_FBDasZhouEtAl/MamPhy_BDvr_Completed_5911sp_topoCons_FBDasZhouEtAl_v2_tree1000.tre") # Upham
sharktree <- read.nexus("../trees/10cal.tree250.nex") #Mull 
fishtree <- read.tree("../trees/actinopt_12k_treePL.tre") #Rabosky
croctree <- readRDS("../trees/crocTree.RDS")
turtletree <- drop.tip(read.nexus("../trees/bd.mcc.median_heights.tre"), c("AA_Alligator", "AA_Ggallus"))
turtletree$tip.label <- sapply(strsplit(turtletree$tip.label, "_"), function(x) paste(x[1], x[2], sep="_"))
turtletree <- drop.tip(turtletree, which(duplicated(turtletree$tip.label)))
trees <- list("sharks"=sharktree, "fish"=fishtree, "amphib"=amphib, "squamates"=squam, "birds"=birds, "mamm"=mamm, "turtles"=turtletree, "crocs"=croctree)
```

```{r eval=FALSE}
ntips <- length(trees)
tip.labels <- c("sharks","fish", "amphib", "squamates", "birds", "mamm", "turtles", "crocs")
edge <- matrix(c(
  15, 5,
  15, 8,
  14, 15,
  14, 7,
  13, 14,
  13, 4,
  12, 13,
  12, 6,
  11, 12,
  11, 3,
  10, 11,
  10, 2,
  9, 10,
  9, 1), byrow=TRUE, ncol=2)
#Medians:
#edge.length <- rep(1, nrow(edge))
edge.length <- c("bird"=245, "croc"=245  ,"croc_stem"=261-245,"turt"=261,"turt_stem"=281-261, "squam"=281,"arch_stem"=319-281,"mamm"=319, "amniote_stem"=353-319, "amphib" = 353, "tet_stem"=431-353, "fish"=431, "fish_stem"=464-431, "shark"=464)
#edge.length <- c(282, 282, 318-282, 318, 351.7, 351.7-318, 433-351.7, 433, 465-433, 465)
#Means
#edge.length <- c(280, 280, 312-280, 312, 378.3, 378.3-312, 435-378.3, 435, 473-435, 473)
Nnode <- 7
ordertree <- list(edge=edge, Nnode=Nnode, tip.label=tip.labels, edge.length=unname(edge.length))
class(ordertree) <- 'phylo'
ordertree <- reorder.phylo(ordertree, "postorder")
plot(ordertree)
```

```{r eval=FALSE}
otax <- data.frame("Class"= ordertree$tip.label, "Superclass"=c("Chondrichthyes", "Actinopterygii", rep("Tetrapoda",6)))
rownames(otax) <- ordertree$tip.label
classtree <- nodelabel.phylo(ordertree, otax, ncores=1)

#trees <- lapply(tds, function(x) x$phy)
trees <- lapply(trees, multi2di)
class(trees) <- "multiPhylo"
plot(classtree)
abline(v=sapply(trees, function(x) max(nodeHeights(x))),lty=2)
res <- glomogram.phylo(classtree, trees)
res
saveRDS(res, file="../output/allchordates_6_8.rds")
```



```{r}
#some functions to match to the OpenTree of Life taxonomy.
 simpleCap <- function(x) {
    s <- strsplit(x, " ")[[1]]
    paste(toupper(substring(s, 1,1)), substring(s, 2),
          sep="", collapse=" ")
  }
  getOttIds <- function(taxalist, ncores=1, context=NULL){
    scipen <- options()$scipen
    digits <- options()$digits
    options("scipen"=100, "digits"=4)
    .taxalist <- gsub("_", " ", taxalist)
    .taxalist <- gsub(" sp$", "", .taxalist)
    tax <- parallel::mclapply(1:length(taxalist),  function(i) try(rotl::tnrs_match_names(.taxalist[i], do_approximate_matching =FALSE, context_name = context)), mc.cores=ncores)
    failed <- which(sapply(tax,function(x) class(x)[1]=="try-error"))
    if(length(failed)>0){
      tax[failed] <- parallel::mclapply(failed,  function(i) try(rotl::tnrs_match_names(.taxalist[i], do_approximate_matching =TRUE, context_name = context)), mc.cores=ncores)
    }
    stillfailed <- which(sapply(tax,function(x) if(class(x)[1]=="try-error"){TRUE} else {is.na(x$ott_id)} ))
    if(length(stillfailed>0)){
      tax[stillfailed] <- lapply(stillfailed, function(x) data.frame(search_string=.taxalist[x], unique_name=.taxalist[x], approximate_match=NA, ott_id=NA, is_synonym=NA, flags=NA, number_matches=0))
    }
    tax <- do.call(rbind, tax)
    genspec <- unname(sapply(tax[,2], function(x) paste(strsplit(x, split=" ")[[1]][1:2],collapse=" ")))
    genspec <- gsub(" (genus", " sp.", genspec, fixed=TRUE)
    genspec <- gsub(" NA", " sp.", genspec, fixed=TRUE)
    if(sum(duplicated(genspec))>0){
      cat("Dropping duplicated taxa: ", paste(taxalist[duplicated(genspec)], collapse=", "), "\n")
    }
    if(sum(is.na(tax$ott_id))>0){
      cat("No ott ids found for taxa: ", paste(taxalist[is.na(tax$ott_id)], collapse=", "), "\n")
    }
    tax_unique <- tax[!(duplicated(genspec) | is.na(tax$ott_id)),]
    tax_unique$ottids <- as.character(tax_unique$ott_id)
    options("scipen"=scipen, "digits"=digits)
    tax_unique[,1] <- gsub(" ", "_", tax_unique[,1])
    tax_unique[,1] <- sapply(tax_unique[,1], function(x) simpleCap(x))
    return(tax_unique)
  }
  
  getTaxonomyTable <- function(taxalist, rank="family"){
  simpleCap <- function(x) {
    s <- strsplit(x, " ")[[1]]
    paste(toupper(substring(s, 1,1)), substring(s, 2),
          sep="", collapse=" ")
  }
  getOttIds <- function(taxalist, ncores=1, context=NULL){
    scipen <- options()$scipen
    digits <- options()$digits
    options("scipen"=100, "digits"=4)
    .taxalist <- gsub("_", " ", taxalist)
    .taxalist <- gsub(" sp$", "", .taxalist)
    tax <- parallel::mclapply(1:length(taxalist),  function(i) try(rotl::tnrs_match_names(.taxalist[i], do_approximate_matching =FALSE, context_name = context)), mc.cores=ncores)
    failed <- which(sapply(tax,function(x) class(x)[1]=="try-error"))
    if(length(failed)>0){
      tax[failed] <- parallel::mclapply(failed,  function(i) try(rotl::tnrs_match_names(.taxalist[i], do_approximate_matching =TRUE, context_name = context)), mc.cores=ncores)
    }
    stillfailed <- which(sapply(tax,function(x) if(class(x)[1]=="try-error"){TRUE} else {is.na(x$ott_id)} ))
    if(length(stillfailed>0)){
      tax[stillfailed] <- lapply(stillfailed, function(x) data.frame(search_string=.taxalist[x], unique_name=.taxalist[x], approximate_match=NA, ott_id=NA, is_synonym=NA, flags=NA, number_matches=0))
    }
    tax <- do.call(rbind, tax)
    genspec <- unname(sapply(tax[,2], function(x) paste(strsplit(x, split=" ")[[1]][1:2],collapse=" ")))
    genspec <- gsub(" (genus", " sp.", genspec, fixed=TRUE)
    genspec <- gsub(" NA", " sp.", genspec, fixed=TRUE)
    if(sum(duplicated(genspec))>0){
      cat("Dropping duplicated taxa: ", paste(taxalist[duplicated(genspec)], collapse=", "), "\n")
    }
    if(sum(is.na(tax$ott_id))>0){
      cat("No ott ids found for taxa: ", paste(taxalist[is.na(tax$ott_id)], collapse=", "), "\n")
    }
    tax_unique <- tax[!(duplicated(genspec) | is.na(tax$ott_id)),]
    tax_unique$ottids <- as.character(tax_unique$ott_id)
    options("scipen"=scipen, "digits"=digits)
    tax_unique[,1] <- gsub(" ", "_", tax_unique[,1])
    tax_unique[,1] <- sapply(tax_unique[,1], function(x) simpleCap(x))
    return(tax_unique)
  }
  otts <- getOttIds(taxalist)
  taxonomies <- lapply(otts$ott_id, function(x) rotl::taxonomy_taxon_info(x, include_lineage = TRUE))
  taxonomies <- lapply(taxonomies, function(x) do.call(rbind, x[[1]]$lineage))
  taxonomies <- lapply(taxonomies, function(x) x[x[,"rank"]==rank,])
  taxtable <- do.call(rbind, taxonomies)
  return(taxtable)
}
```

Match the names to the Open Tree of Life taxonomy to match it to the names on the tree:
```{r}
dat$species <- gsub(" ", "_", dat$species)
ott_table <- getOttIds(dat$species, ncores=2)
saveRDS(ott_table, file="../output/ott_table_data.rds")
```


```{r}
#ott_table_fish <- getOttIds(dat$species[dat$class=="Actinopterygii"], ncores=3)
#ott_table <- readRDS("./ott_table_data.rds")
#ott_table_full <- rbind(ott_table_fish, ott_table)
#saveRDS(ott_table_full, file="~/repos/vtparity/ott_table_full.rds")
```

```{r}
ott_table <- readRDS(file="../output/ott_table_data.rds")
# Function to get the taxonomy
otts <- ott_table
rank <- "class"
.taxonomies <- lapply(otts[,'ott_id'], function(x) rotl::taxonomy_taxon_info(x, include_lineage = TRUE))
taxonomies <- lapply(.taxonomies, function(x) do.call(rbind, x[[1]]$lineage))
ranks <- c("genus", "family", "infraorder", "order", "superorder", "order", "subclass", "class", "superclass", "subphylum", "phylum")
taxtable <- data.frame(matrix(NA, nrow=length(taxonomies), ncol=length(ranks)))
colnames(taxtable) <- ranks
taxtable$species <- otts[,'unique_name']
for(j in 1:length(ranks)){
  for(i in 1:length(taxonomies)){
  log.test <- unlist(taxonomies[[i]][,'rank'])==ranks[j]
  if(any(log.test)){
    taxtable[i, ranks[j]] <- taxonomies[[i]][log.test, "name"][[1]]
  } else {
    taxtable[i, ranks[j]] <-NA
  }
}
}
saveRDS(taxtable, "../output/ott_tax_table.rds")
```


```{r}
#Read taxonomy table back in
ott_table <- readRDS(file="../output/ott_table_data.rds")
tax_table <- readRDS("../output/ott_tax_table.rds")
td_tree <- readRDS("../output/matched_tree_ott.rds")
tree <- td_tree$phy
tree$tip.label <- gsub(" ", "_", td_tree$dat$ott_name)
```


```{r}
dat <- read.csv("../datasets/vtparity.csv")
fishdat <- read.csv("../datasets/final_vtparity_fishdata_complete.csv")

#fishdat$AaM[which(fishdat$AaM == "1.5-2")] <- "1.75"
#fishdat$mass[which(fishdat$mass == "2.0-89.0")] <- "89.0"
unique(fishdat$mass)
fishdat$AaM <- as.numeric(fishdat$AaM)
fishdat$mass <- as.numeric(fishdat$mass)
fishdat <- mutate(fishdat, birth.mass=NA)
.fishdat <- dplyr::select(fishdat, colnames(dat))
ordind <- match(.fishdat$species, dat$species)
newdat <- dat
for(i in 1:nrow(.fishdat)){
  tofill <- which(is.na(dat[ordind[i], ]) & !is.na(.fishdat[i, ]))
  newdat[ordind[i], tofill] <- .fishdat[i, tofill]
}
newdat$genspec <- NA # Create genspec
index <- match(ott_table$search_string, gsub(" ", "_", newdat$species)) #match ott_table to data table
drop <- which(is.na(index)) #Some failed, record these
newdat$genspec[index[-drop]] <- ott_table$unique_name[-drop] # Give the ott names to genspec

ndat <- filter(newdat, !is.na(genspec)) # Keep only the ones that worked
ndat$genspec <- gsub(" ", "_", ndat$genspec) #underscores
td <- make.treedata(tree, ndat)#match tree and data. 
saveRDS(td, "../output/chordatedata_matched_new_ott.rds")
```

```{r}
library(dplyr)

lens <- read.csv("../datasets/VTparity_length_mass.csv")
#taking the mean for each species
length(lens$Species)
g <- aggregate(cbind(lens$a, lens$b), by = list(lens$Species), mean)
colnames(g) <- c("Species", "a", "b")
shark_lens <- read.csv("../datasets/Shark.VTparity.data.csv")
shark_lens <- dplyr::select(shark_lens, c(4,15,16))
colnames(shark_lens) <- c("Species",  "a","b")
lens_attempt <- merge(lens, shark_lens, by = "Species")
colnames(lens_attempt) <- c("Species","X", "a1","b1","a","b")

# changing values when they are different
ind <- which(lens_attempt$a1 != lens_attempt$a)
change <- lens_attempt[ind,]
lens_shark <- data.frame(lens$Species, lens$a, lens$b)
colnames(lens_shark) <- c("species","a","b")
#old_dat <- read.csv("../datasets/vtparity.csv")
dat <- read.csv("../datasets/vtparity.csv")
dat <- data.frame(dat)

#merging the two 
#full_dat <- merge(dat, lens_shark, by = "species", all.x = T)

g <- data.frame(g)
names(g) <- c("species", "a","b")

# combo of both datasets 
get <- plyr::join(g, dat, by = 'species', type = "full")

#get_mass <- mutate(get, mass_est = a * (svl^b))

#converting 
get$a <- ifelse(get$a < 0, yes = exp(get$a), get$a)

transformed_dat <- saveRDS(get, file = "../output/transformed_dat.RDS")

get_mass_con <- mutate(get, logSVL = log(svl,10), logMass = log(mass))

get_mass_jo <- mutate(get_mass_con, logEstMass = log((a*svl)^b))#(b * logSVL + log((a),10))* 1/log(exp(1),10))

#saving 
saveRDS(get_mass_jo, file = "../output/NB_massEst.RDS")
mass_est <- readRDS("../output/NB_massEst.RDS")

lm1 <- lm(mass_est$logEstMass / 3 ~  mass_est$logSVL)
#main plot
plot(mass_est$logSVL, mass_est$logEstMass / 3, pch = 16, cex = 1.3, col = "red", 
     main = "log(estMass)/3 and log10SVL", xlab = "log10SVL", ylab = " log(estMass) / 3")
abline(lm1)

# dropping based on residual
lm1.res <- (resid(lm1))
plot(lm1.res)
res_ind <- (which((lm1.res) < -2))
r <- as.data.frame(res_ind)
q <- as.numeric(rownames(r))
res_ind <- c(r$res_ind, q)
# outliers based on the residuals, not sure whether the reptiles should be dropped
res_out <- mass_est[res_ind,]

# dropped dataset 
mass_est <- mass_est[-res_ind, ]
saveRDS(mass_est, file = "../output/NB_massEst_NoOutliers.RDS")

par(mfrow = c(2,1))
hist(get_mass_jo$a)
hist(res_out$a)


# things to be dropped based on svl and estMass
ind_out <- which(get_mass_jo$logEstMass < 0 & get_mass_jo$logSVL > 2.5)
eye_out <- get_mass_jo[ind_out,]

par(mfrow = c(2,1))
hist(eye_out$a)
hist(res_out$a)

```


II. Load in matched tree and data. 
  
```{r}
td0 <- readRDS("../output/chordatedata_matched_new_ott.rds")
newmass <- readRDS("../output/NB_massEst_NoOutliers.RDS")
mergemass <- left_join(td0$dat, newmass)
mergemass <- mutate(mergemass, lnSize=ifelse(is.na(logMass)==TRUE, logEstMass/3, logMass/3))
mergemass$lnSize[mergemass$class=="Actinopterygii" & !is.na(mergemass$lnSize)] <- mergemass$lnSize[mergemass$class=="Actinopterygii" & !is.na(mergemass$lnSize)] - log(10)
mergemass$lnSize[mergemass$class=="Actinopterygii" & is.na(mergemass$lnSize)] <- log((0.007 * mergemass$svl[mergemass$class=="Actinopterygii" & is.na(mergemass$lnSize)])^3.0904)/3 #(3.0904 * log(mergemass$svl[mergemass$class=="Actinopterygii" & is.na(mergemass$lnSize)], 10) + log(0.007,10))/3 *  1/log(exp(1),10)
mergemass$species <- td0$phy$tip.label
testudines_allometry <- read.csv("../datasets/turtles_AllometryofSexualSizeDimorphism.csv")
testudines_allometry$genspec <- paste(testudines_allometry$Genus, testudines_allometry$Species, sep="_")

#For species with female mass, set female mass directly
female_turt_mass <- setNames(testudines_allometry$F.Mass..g., testudines_allometry$genspec)
mergemass$mass[mergemass$order=="Testudines"] <- unname(female_turt_mass[mergemass$species[mergemass$order=="Testudines"]])
mergemass$lnSize[mergemass$order=="Testudines" & is.na(mergemass$lnSize)] <- log(mergemass$mass[mergemass$order=="Testudines"])/3

#For species with only SCL, calculate allometry
y <- log(c(testudines_allometry$M.Mass..g., testudines_allometry$F.Mass..g.))
x <- log(c(testudines_allometry$M.SCL..mm., testudines_allometry$F.SCL..mm.))
lm1 <- lm(y~x, na.action = "na.omit")
mergemass$lnSize[mergemass$order=="Testudines" & is.na(mergemass$lnSize)] <- (lm1$coef[1] + lm1$coef[2]*log(mergemass$svl[mergemass$order=="Testudines" & is.na(mergemass$lnSize)]))/3

td <- make.treedata(td0$phy, mergemass)

plot(td$dat$logSVL, td$dat$lnSize)
points(td$dat$logSVL[td$dat$order=="Testudines"], td$dat$lnSize[td$dat$order=="Testudines"], col="red")
 
 
.td <- filter(td, class=="Actinopterygii")
plot(.td[['logSVL']], .td[['lnSize']])
plot(td[['logSVL']], td[['lnSize']], pch=21, bg=(td$dat$class=="Actinopterygii")+1)
plot(td[['logSVL']], td[['lnSize']], pch=21, bg=(td$phy$tip.label=="Catlocarpio_siamensis")+1)


saveRDS(td, "../output/chordatedata_matched_estSizeComplete.rds")
```



```{r}
head(data.frame(arrange(cbind(td$phy$tip.label, td$dat), desc(lnSize))),100)
```

Can skip these. Comparison with timetree of life.

```{r eval=FALSE}
# With the timetree of life
ttol <- load("~/repos/aRbor/treetimer/data/ttolData.rda")
td2 <- make.treedata(ttolData$phy, ndat)
```

```{r eval=FALSE}
cat("Original dataset \n")
table(dat[['class']])
cat("My supertree \n")
table(td[['order']])
#cat("TimeTree of Life \n")
#table(td2[['order']])
```

III. Exploration with castor and juvenile/adult terrestriality. Doesn't work great!!!

```{r eval=FALSE}

rmtd <- filter(td, !is.na(repmode))
priortable <- matrix(0, nrow=length(rmtd$phy$tip.label), ncol=4)
x <-y <-0
for(i in 1:nrow(priortable)){
  if(rmtd[['repmode']][i]==1){
    if(x==0){
       priortable[i, c(3,4)] <- c(1,0)
       x <- 5
    } else {
       priortable[i, c(3,4)] <- NA
    }
   
    
  } else {
    if(y==0){
       priortable[i, c(1,2)] <- c(1,0)
       y <- 5
    } else {
    priortable[i, c(1,2)] <- NA
    }
  }
}

```

```{r}
rmtd <- filter(td, !is.na(repmode))#removing NAs

```

```{r}
rmMtd <- rmtd#filter(rmtd, !is.na(adMort), !order %in% c("Anura", "Caudata", "Gymnophiona"))
p1 <- contMap(rmMtd$phy, rmMtd[['repmode']], fsize=0.1)
p1 <- setMap(p1, c("#3498db", "#f1c40f", "#e74c3c"))
pdf("./repmode.pdf", height=20, width=20)
plot(p1, fsize=0.2, type="fan")
dev.off()
```

```{r}
rmASR <- castor::asr_mk_model(rmtd$phy, rmtd[['repmode']]+1, rate_model = "ARD") #ancestral state for reproductive mode

```


```{r}
#pdf("./repmode.pdf", height=100, width=6)
plot(rmtd$phy, type="fan", show.tip.label=FALSE, cex=0.2)
# ancestral state for ad and juv enviornment 
terr2td <- filter(td, !is.na(AdTerr)) # this has 14k juv and adult, removing NA 
# converting to 00 -- 11
t2 <- terr2td$dat
t2['new'] <- NA
t2$new <- as.integer(case_when(
      t2$juvTerr == 1 & t2$AdTerr == 1 ~ "1",
      t2$juvTerr == 1 & t2$AdTerr == 0 ~ "2",
      t2$juvTerr == 0 & t2$AdTerr == 1 ~ "3",
      t2$juvTerr == 0 & t2$AdTerr == 0 ~ "4"
    ))
Ad_ASR <- castor::asr_mk_model(tree = terr2td$phy, tip_states = t2$new, rate_model = "ARD")
solution <- Ad_ASR$transition_matrix
rownames(solution) <- c("11","10","01","00")
colnames(solution) <- c("11","10","01","00")
solution
```

```{r}
# meh
pdf("./JuvAdTerr.pdf", height=100, width=6)
plot(terr2td$phy, show.tip.label=TRUE, cex=0.2)
nodelabels(cex=0.25, pie=Ad_ASR$ancestral_likelihoods,piecol=c("blue","green","red","purple"), col="transparent", lwd=0.01)
tiplabels(cex=0.25, pch=21, bg=c("blue", "green", "red", "purple")[t2[['new']]], col=c("blue", "green", "red", "purple")[t2[['new']]])
dev.off()
```


```{r}
pdf("./repmode_full.pdf", height=100, width=6)
plot(rmtd$phy, show.tip.label=TRUE, cex=0.2)
nodelabels(cex=0.25, pie=rmASR$ancestral_likelihoods, piecol=c("#bdc3c7", "#e74c3c"), col="transparent", lwd=0.01)
tiplabels(cex=0.25, pch=21, bg=c("#bdc3c7", "#e74c3c")[rmtd[['repmode']]+1], col=c("#bdc3c7", "#e74c3c")[rmtd[['repmode']]+1])
#nodelabels(cex=0.25, pie=rmASR$likelihoods, piecol=c("#bdc3c7", "#34495e", "#e74c3c", "#f1c40f"), col="transparent", lwd=0.01)
#tiplabels(cex=0.25, pch=21, bg=c("#bdc3c7", "#e74c3c")[rmtd[['repmode']]+1], col=c("#bdc3c7", "#e74c3c")[rmtd[['repmode']]+1])
dev.off()
```


```{r}
plot(rmtd[['log.AaM']], rmtd[['juvMort']])
```

IV. Phylolm analyses
Get cases that have reproductive mode
```{r}
library(phylolm)
rmtd <- filter(td, !is.na(repmode))#removing NAs
table(rmtd$dat$order)
rmtd <- mutate(rmtd, scjMort = scale(juvMort)[,1], scadMort = scale(adMort)[,1], scSize=scale(lnSize)[,1], lnLongevity=log(longevity))
rmtd$dat$species <- rmtd$phy$tip.label
#rmtd$dat$AdTerr[is.na(rmtd$dat$AdTerr) & rmtd$dat$order=="Squamata"] <- 1
```


Some patches and some fits to get predictions
```{r}
#rmtd$dat$AdTerr[is.na(rmtd$dat$AdTerr) & rmtd$dat$order=="Squamata"] <- 1
rmMtd <- filter(rmtd, !is.na(adMort), !is.na(lnSize), !is.na(juvMort))
## Patches:
rmMtd$dat$AdTerr[rmMtd$dat$species=="Typhlonectes_compressicauda"] <- 0
rmMtd$dat$repmode[rmMtd$dat$species=="Uromastyx_acanthinura"] <- 0
rmMtd$dat$repmode[rmMtd$dat$species=="Pogona_vitticeps"] <- 0
```

3 way Regression to show negative relationships
```{r}
library(Rphylopars)
ftd <- mutate(td, scjMort = scale(juvMort)[,1], scadMort = scale(adMort)[,1], scSize=scale(lnSize)[,1], lnLongevity=log(longevity)) %>% mutate(., na1 = is.na(scSize) + is.na(scadMort) + is.na(scjMort)) %>% filter(., na1 < 2)
.df <- data.frame(species=ftd$phy$tip.label, dplyr::select(ftd$dat, scSize, scadMort, scjMort))
ltrns <- geiger::rescale(ftd$phy, "lambda")
NP0 <- phylopars(trait_data=.df, tree=ltrns(0), pheno_error=FALSE, phylo_correlated=TRUE, pheno_correlated=FALSE, model="lambda")
## Non phylogenetic covariance matrix missing up 1
cov2cor(NP0$pars$phylocov)
pairs(as.data.frame(dplyr::select(ftd$dat, scSize, scadMort, scjMort)))

```

```{r}
ftd <- mutate(td, scjMort = scale(juvMort)[,1], scadMort = scale(adMort)[,1], scSize=scale(lnSize)[,1], lnLongevity=log(longevity)) %>% mutate(., na1 = is.na(scSize) + is.na(scadMort) + is.na(scjMort)) %>% filter(., na1 < 3)
.df <- data.frame(species=ftd$phy$tip.label, dplyr::select(ftd$dat, scSize, scadMort, scjMort))
PPE.m2 <- phylopars(trait_data=.df, tree=ftd$phy, pheno_error=FALSE, phylo_correlated=TRUE, pheno_correlated=FALSE, model="lambda")
## Phylogenetic, lambda, missing up to 2
cov2cor(PPE.m2$pars$phylocov)
```

```{r}
ftd <- mutate(td, scjMort = scale(juvMort)[,1], scadMort = scale(adMort)[,1], scSize=scale(lnSize)[,1], lnLongevity=log(longevity)) %>% mutate(., na1 = is.na(scSize) + is.na(scadMort) + is.na(scjMort)) %>% filter(., na1 < 2)
.df <- data.frame(species=ftd$phy$tip.label, dplyr::select(ftd$dat, scSize, scadMort, scjMort))
PPE.m1 <- phylopars(trait_data=.df, tree=ftd$phy, pheno_error=FALSE, phylo_correlated=TRUE, pheno_correlated=FALSE, model="lambda")
## Phylogenetic, lambda, missing up to 1
cov2cor(PPE.m1$pars$phylocov)
```

```{r}
ftd <- mutate(td, scjMort = scale(juvMort)[,1], scadMort = scale(adMort)[,1], scSize=scale(lnSize)[,1], lnLongevity=log(longevity)) %>% mutate(., na1 = is.na(scSize) + is.na(scadMort) + is.na(scjMort)) %>% filter(., na1 == 0)
.df <- data.frame(species=ftd$phy$tip.label, dplyr::select(ftd$dat, scSize, scadMort, scjMort))
PPE.m0 <- phylopars(trait_data=.df, tree=ftd$phy, pheno_error=FALSE, phylo_correlated=TRUE, pheno_correlated=FALSE, model="lambda")
## Phylogenetic, lambda, missing none w/BM
cov2cor(PPE.m0$pars$phylocov)
```

```{r}
ftd <- mutate(td, scjMort = scale(juvMort)[,1], scadMort = scale(adMort)[,1], scSize=scale(lnSize)[,1], lnLongevity=log(longevity)) %>% mutate(., na1 = is.na(scSize) + is.na(scadMort) + is.na(scjMort))
.df <- data.frame(species=ftd$phy$tip.label, select(ftd$dat, scSize, scadMort, scjMort))
PPE.m3 <- phylopars(trait_data=.df, tree=ftd$phy, pheno_error=FALSE, phylo_correlated=TRUE, pheno_correlated=FALSE, model="BM")
## Phylogenetic, no lambda, missing up to 3 imputed with BM
cov2cor(PPE.m3$pars$phylocov)
```

##############################


```{r}
table(rmMtd$dat$order)
sum(table(rmMtd$dat$order))
rownames(rmMtd$dat) <- rmMtd$phy$tip.label
#glmfit <- phyloglm(repmode ~ scjMort*AdTerr + scadMort*AdTerr, data=rmMtd$dat, phy=rmMtd$phy, btol=20)
#glmfitstep <- phyloglmstep(repmode ~ scjMort*AdTerr*scadMort*IF, data=rmMtd$dat, phy=rmMtd$phy, btol=20)
#oglmfit <- glm(repmode ~ 1 + scjMort + scadMort + juvTerr + scjMort:juvTerr + scadMort:juvTerr, data=rmMtd$dat)
glmfitalt2 <- glm(repmode ~ scadMort*AdTerr + IF + lnLongevity + scjMort*Terr, data=rmMtd$dat)
glmfitalt3 <- glm(repmode ~Terr*scjMort + lnSize*scjMort + IF*scadMort,  data=rmMtd$dat)
glmfitalt1 <- phyloglm(repmode ~  Terr*scjMort+ lnSize*scjMort +  IF*scadMort, data=rmMtd$dat, phy=rmMtd$phy, method="logistic_IG10", start.beta=glmfitalt3$coef)

glmfitalt4 <- glm(repmode ~scjMort + scadMort + lnSize,  data=rmMtd$dat)
glmfitalt5 <- phyloglm(repmode ~scjMort + scadMort + lnSize, data=rmMtd$dat, phy=rmMtd$phy, method="logistic_IG10", start.beta=glmfitalt4$coef)

#glmfitalt4 <- glm(repmode ~scjMort*scadMort + lnSize*scjMort + scadMort*IF,  data=rmMtd$dat)
#glmfitalt5 <- phyloglm(repmode ~  scjMort*scadMort+ lnSize*scjMort + scadMort*IF, data=rmMtd$dat, phy=rmMtd$phy, method="logistic_IG10", start.beta=glmfitalt4$coef)

```

```{r}
#summary(glmfitstep)
summary(glmfitalt1)
summary(glmfitalt2)
summary(glmfitalt3)
summary(glmfitalt4)
summary(glmfitalt5)

```

```{r}
plot(rmMtd$dat$lnSize, rmMtd$dat$scjMort, pch=21, bg=rmMtd$dat$Terr+1)
plot(rmMtd$dat$lnSize, rmMtd$dat$scadMort, pch=21, bg=rmMtd$dat$Terr+1)
plot(rmMtd$dat$lnSize, rmMtd$dat$scadMort+rmMtd$dat$scjMort, pch=21, bg=rmMtd$dat$Terr+1)


```



Choose one of the models and get predictions in the dataframe rmMtd that we can compare and plot
```{r}
model <- glmfitalt2
rmMtd$dat$predicted  <- round(model$fitted.values,4)
rmMtd$dat$residual  <- round(model$residuals,4)
par(mar=c(10,5,1,1))
boxplot(predicted ~ repmode + class, data=rmMtd$dat, las=2, xlab="", col=c("#f1c40f", "#e74c3c"))
plot(rmMtd$dat$predicted, jitter(rmMtd$dat$repmode))
```


V. DOESN'T RUN - CAUSES CRASH. Trying to use phylopars.
```{r}
#rmTtd <- filter(rmtd, !is.na(AdTerr), order=="Sharks")
rmtd$phy$edge.length[rmtd$phy$edge.length==0] <- 0.01
rmtd$phy <- phytools::force.ultrametric(rmtd$phy)
rmTtd <- filter(rmtd, order=="Sharks")
pparsalt1 <- Rphylopars::phylopars.lm(repmode ~ scadMort, trait_data=rmtd$dat, tree=rmTtd$phy)
summary(pparsalt1)
```


VI. Making contmaps for clade subsets
```{r}
sharktd <-filter(rmMtd, class %in% c("Sharks"))
p1 <- phytools::contMap(sharktd$phy, sharktd[['repmode']], fsize=0.5)
p2 <- phytools::contMap(sharktd$phy, sharktd[['predicted']], fsize=0.5)
p3 <- phytools::contMap(sharktd$phy, abs(sharktd[['residual']]), fsize=0.5)
p1 <- setMap(p1, c("#3498db", "#f1c40f", "#e74c3c"))
p2 <- setMap(p2, c("#3498db", "#f1c40f", "#e74c3c"))
p3 <- setMap(p3, c("#3498db", "#f1c40f", "#e74c3c"))
#pdf("./sharkpredict.pdf", width=20, height=15)
par(mfrow=c(1,3))
plot(p1, ftype="off")
plot(p2, ftype="off")
plot(p3, ftype="off")
#dev.off()
```


```{r}
amphibtd <-filter(rmMtd, class %in% c("Amphibia","Reptilia"))
p1 <- phytools::contMap(amphibtd$phy, amphibtd[['repmode']], fsize=0.5, )
p2 <- phytools::contMap(amphibtd$phy, amphibtd[['predicted']], fsize=0.5)
p3 <- phytools::contMap(amphibtd$phy, amphibtd[['residual']], fsize=0.5)
p1 <- setMap(p1, c("#3498db", "#f1c40f", "#e74c3c"))
p2 <- setMap(p2, c("#3498db", "#f1c40f", "#e74c3c"))
p3 <- setMap(p3, c("#3498db", "#f1c40f", "#e74c3c"))
#pdf("./amphibpredict.pdf", width=20, height=15)
par(mfrow=c(1,3))
plot(p1)
plot(p2)
plot(p3)
#dev.off()
```

```{r}
fishclass <- unique(rmMtd$dat$class[!rmMtd$dat$class %in% c("Sharks", "Mammalia", "Reptilia", "Aves", "Amphibia")])
```


VII. Making RGL 3d plots. Needs to have the predicted values from section IV.

```{r}
library(scatterplot3d)
library(rgl)
library(car)
#View(arrange(amphibtd$dat, desc(predicted)))
predscale <- floor((rmMtd$dat$predicted-min(rmMtd$dat$predicted))/diff(range(rmMtd$dat$predicted))*99)+1
#scatter3d(x=rmMtd$dat$lnSize, y=rmMtd$dat$scadMort, z=rmMtd$dat$scjMort,  xlab="Size", ylab="Juv. Mortality", zlab="Adult Mortality",pch=21,point.col=colorRampPalette(c("#3498db", "#2ecc71", "#f1c40f", "#e74c3c"))(100)[predscale], surface=FALSE, sphere.size=predscale^(1/3))
.rmMtd <- rmMtd
predscale <- floor((.rmMtd$dat$predicted-min(rmMtd$dat$predicted))/diff(range(rmMtd$dat$predicted))*99)+1
spherecol <- colorRampPalette(c("#3498db", "#e74c3c"))(2)[.rmMtd$dat$repmode+1]
terrcol <-  colorRampPalette(c("#2980b9", "#e67e22"))(2)[.rmMtd$dat$Terr+1]
pmsDat <- cbind(BS=.rmMtd$dat$logMass3, AM=.rmMtd$dat$scadMort, OM=.rmMtd$dat$scjMort)
rownames(pmsDat) <- .rmMtd$phy$tip.label

scatter3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,  xlab="Adult Mortality", ylab="Juv. Mortality", zlab="Size", point.alpha=10, fogtype="none",point.col=terrcol, surface=FALSE, sphere.size=(predscale/3)^(1/3))
#Identify3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,labels=.rmMtd$dat$species, offset=0.05)

```

Mammals

```{r}
.rmMtd <- mutate(rmMtd, plotcode = 1 + 2*(class %in% c("Mammalia")) + repmode )
predscale <- floor((.rmMtd$dat$predicted-min(rmMtd$dat$predicted))/diff(range(rmMtd$dat$predicted))*99)+1
spherecol <- c("#ecf0f1", "#bdc3c7", "#3498db", "#e74c3c")[.rmMtd$dat$plotcode]
#pmsDat <- cbind(BS=.rmMtd$dat$lnSize, AM=.rmMtd$dat$scadMort, OM=.rmMtd$dat$scjMort)
#rownames(pmsDat) <- .rmMtd$phy$tip.label


scatter3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$logMass3,  xlab="Adult Mortality", ylab="Juv. Mortality", zlab="Size", point.alpha=10, fogtype="none",point.col=spherecol, surface=FALSE, sphere.size=(predscale/3)^(1/3))
#Identify3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,labels=.rmMtd$dat$species, offset=0.05)

```


Birds

```{r}
.rmMtd <- mutate(rmMtd, plotcode = 1 + 2*(class %in% c("Aves")) + repmode )
predscale <- floor((.rmMtd$dat$predicted-min(rmMtd$dat$predicted))/diff(range(rmMtd$dat$predicted))*99)+1
spherecol <- c("#ecf0f1", "#bdc3c7", "#3498db", "#e74c3c")[.rmMtd$dat$plotcode]
#pmsDat <- cbind(BS=.rmMtd$dat$lnSize, AM=.rmMtd$dat$scadMort, OM=.rmMtd$dat$scjMort)
#rownames(pmsDat) <- .rmMtd$phy$tip.label


scatter3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,  xlab="Adult Mortality", ylab="Juv. Mortality", zlab="Size", point.alpha=10, fogtype="none",point.col=spherecol, surface=FALSE, sphere.size=(predscale/3)^(1/3))
#Identify3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,labels=.rmMtd$dat$species, offset=0.05)

```



Amphibians

```{r}
.rmMtd <- mutate(rmMtd, plotcode = 1 + 2*(class %in% c("Amphibia", "Reptilia", "Actinopterygii")) + repmode )
predscale <- floor((.rmMtd$dat$predicted-min(rmMtd$dat$predicted))/diff(range(rmMtd$dat$predicted))*99)+1
spherecol <- c("#ecf0f1", "#bdc3c7", "#3498db", "#e74c3c")[.rmMtd$dat$plotcode]
#pmsDat <- cbind(BS=.rmMtd$dat$lnSize, AM=.rmMtd$dat$scadMort, OM=.rmMtd$dat$scjMort)
#rownames(pmsDat) <- .rmMtd$phy$tip.label

scatter3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,  xlab="Adult Mortality", ylab="Juv. Mortality", zlab="Size", point.alpha=10, fogtype="none",point.col=spherecol, surface=FALSE, sphere.size=(predscale/3)^(1/3))
#Identify3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,labels=.rmMtd$dat$species, offset=0.05)

```

Squamates

```{r}
.rmMtd <- mutate(rmMtd, plotcode = 1 + 2*(class %in% c("Reptilia")) + repmode )
predscale <- floor((.rmMtd$dat$predicted-min(rmMtd$dat$predicted))/diff(range(rmMtd$dat$predicted))*99)+1
spherecol <- c("#ecf0f1", "#bdc3c7", "#3498db", "#e74c3c")[.rmMtd$dat$plotcode]
#pmsDat <- cbind(BS=.rmMtd$dat$lnSize, AM=.rmMtd$dat$scadMort, OM=.rmMtd$dat$scjMort)
#rownames(pmsDat) <- .rmMtd$phy$tip.label


scatter3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,  xlab="Adult Mortality", ylab="Juv. Mortality", zlab="Size", point.alpha=10, fogtype="none",point.col=spherecol, surface=FALSE, sphere.size=(predscale/3)^(1/3))
#Identify3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,labels=.rmMtd$dat$species, offset=0.05)

```

Sharks

```{r}
.rmMtd <- mutate(rmMtd, plotcode = 1 + 2*(class %in% c("Sharks", "Mammalia", "Aves")) + repmode )
predscale <- floor((.rmMtd$dat$predicted-min(rmMtd$dat$predicted))/diff(range(rmMtd$dat$predicted))*99)+1
spherecol <- c("#ecf0f1", "#bdc3c7", "#3498db", "#e74c3c")[.rmMtd$dat$plotcode]
#pmsDat <- cbind(BS=.rmMtd$dat$lnSize, AM=.rmMtd$dat$scadMort, OM=.rmMtd$dat$scjMort)
#rownames(pmsDat) <- .rmMtd$phy$tip.label


scatter3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,  xlab="Adult Mortality", ylab="Juv. Mortality", zlab="Size", point.alpha=10, fogtype="none",point.col=spherecol, surface=FALSE, sphere.size=(predscale/3)^(1/3))
#Identify3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,labels=.rmMtd$dat$species, offset=0.05)
```

Bony Fish

```{r}
.rmMtd <- mutate(rmMtd, plotcode = 1 + 2*(!class %in% c("Sharks", "Aves", "Amphibia", "Reptilia", "Mammalia")) + repmode )
predscale <- floor((.rmMtd$dat$predicted-min(rmMtd$dat$predicted))/diff(range(rmMtd$dat$predicted))*99)+1
spherecol <- c("#ecf0f1", "#bdc3c7", "#3498db", "#e74c3c")[.rmMtd$dat$plotcode]
#pmsDat <- cbind(BS=.rmMtd$dat$lnSize, AM=.rmMtd$dat$scadMort, OM=.rmMtd$dat$scjMort)
#rownames(pmsDat) <- .rmMtd$phy$tip.label


scatter3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,  xlab="Adult Mortality", ylab="Juv. Mortality", zlab="Size", point.alpha=10, fogtype="none",point.col=spherecol, surface=FALSE, sphere.size=(predscale/3)^(1/3))
#Identify3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,labels=.rmMtd$dat$species, offset=0.05)
```


```{r}
.rmMtd <- filter(rmMtd, class %in% c("Amphibia", "Reptilia", ) | family %in% c("Balaenopteridae", "Soricidae", "Cricetidae"))
predscale <- floor((.rmMtd$dat$predicted-min(rmMtd$dat$predicted))/diff(range(rmMtd$dat$predicted))*99)+1
spherecol <- colorRampPalette(c("#3498db", "#e74c3c"))(2)[.rmMtd$dat$repmode+1]
pmsDat <- cbind(BS=.rmMtd$dat$lnSize, AM=.rmMtd$dat$scadMort, OM=.rmMtd$dat$scjMort)
rownames(pmsDat) <- .rmMtd$phy$tip.label
#phylomorphospace3d(.rmMtd$phy, X=pmsDat, control=list(spin=FALSE, ftype="off", method="dynamic",point.col=spherecol, sphere.size=(predscale)^1/3))


scatter3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,  xlab="Adult Mortality", ylab="Juv. Mortality", zlab="Size", point.alpha=10, fogtype="none",point.col=spherecol, surface=FALSE, sphere.size=(predscale/3)^(1/3))
#Identify3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,labels=.rmMtd$dat$species, offset=0.05)

#scatterplot3d(x=rmMtd$dat$lnSize, y=rmMtd$dat$scadMort, z=rmMtd$dat$scjMort, xlab="Size", ylab="Juv. Mortality", zlab="Adult Mortality",pch=21, bg=colorRampPalette(c("#3498db", "#2ecc71", "#f1c40f", "#e74c3c"))(100)[predscale])
```

```{r}
.rmMtd <- filter(rmMtd, !class %in% c("Amphibia", "Reptilia", "Aves", "Mammalia") | family %in% c("Balaenopteridae", "Soricidae", "Cricetidae") | species %in% c("Mantella laevigata"))
predscale <- floor((.rmMtd$dat$predicted-min(rmMtd$dat$predicted))/diff(range(rmMtd$dat$predicted))*99)+1
spherecol <- colorRampPalette(c("#3498db", "#e74c3c"))(2)[.rmMtd$dat$repmode+1]
pmsDat <- cbind(BS=.rmMtd$dat$lnSize, AM=.rmMtd$dat$scadMort, OM=.rmMtd$dat$scjMort)
rownames(pmsDat) <- .rmMtd$phy$tip.label
#phylomorphospace3d(.rmMtd$phy, X=pmsDat, control=list(spin=FALSE, ftype="off", method="dynamic",point.col=spherecol, sphere.size=(predscale)^1/3))


scatter3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,  xlab="Adult Mortality", ylab="Juv. Mortality", zlab="Size", point.alpha=10, fogtype="none",point.col=spherecol, surface=FALSE, sphere.size=(predscale/3)^(1/3))
#Identify3d(x=.rmMtd$dat$scadMort, y=.rmMtd$dat$scjMort, z=.rmMtd$dat$lnSize,labels=.rmMtd$dat$species, offset=0.05)

```

#Ternary plots
```{r}
library(Ternary)

terntd <- td %>% filter(!is.na(juvMort), !is.na(adMort), !is.na(lnSize), !is.na(repmode)) %>% mutate(scSize = lnSize/(abs(diff(range(lnSize,na.rm=TRUE)))/4), scadMort=adMort/(abs(diff(range(adMort,na.rm=TRUE)))/4), scjMort=juvMort/(abs(diff(range(juvMort,na.rm=TRUE)))/4)) %>% mutate(scSize=scSize-min(scSize, na.rm=TRUE), scadMort=scadMort-min(scadMort, na.rm=TRUE), scjMort=scjMort-min(scjMort, na.rm=TRUE)) %>% mutate(trAdMort = scadMort/(scadMort+scjMort+scSize), trJMort = scjMort/(scadMort+scjMort+scSize), trSize = scSize/(scadMort+scjMort+scSize))
terntd$dat$species <- terntd$phy$tip.label
terntd <-filter(terntd, !is.na(trJMort), !is.na(trAdMort), !is.na(trSize)) %>% select(order, class, family,species, trAdMort, trJMort, trSize, repmode, AdTerr, Terr)
Ternary::TernaryPlot(alab="Adult Mortality", blab="Juv Mortality", clab="Body Size", main="Class")
TernaryPoints(terntd$dat[,5:7], pch=21, cex=0.35, bg=terntd$dat$class, col=terntd$dat$class)

Ternary::TernaryPlot(alab="Adult Mortality", blab="Juv Mortality", clab="Body Size", main="Reproductive Mode")
TernaryPoints(terntd$dat[,5:7], pch=21, cex=0.35, bg=terntd$dat$repmode+1, col=terntd$dat$repmode+1)

Ternary::TernaryPlot(alab="Adult Mortality", blab="Juv Mortality", clab="Body Size", main="Adult Terrestrial")
TernaryPoints(terntd$dat[,5:7], pch=21, cex=0.35, bg=terntd$dat$AdTerr+1, col=terntd$dat$AdTerr+1)

Ternary::TernaryPlot(alab="Adult Mortality", blab="Juv Mortality", clab="Body Size", main="Juv Terrestrial")
TernaryPoints(terntd$dat[,5:7], pch=21, cex=0.35, bg=terntd$dat$Terr+1, col=terntd$dat$Terr+1)

Ternary::TernaryPlot(alab="Adult Mortality", blab="Juv Mortality", clab="Body Size", main="Sharks")
.terntd <- filter(terntd, order=="Sharks")
TernaryPoints(.terntd$dat[,5:7], pch=21, cex=0.35, bg=.terntd$dat$repmode+1, col=.terntd$dat$repmode+1)

Ternary::TernaryPlot(alab="Adult Mortality", blab="Juv Mortality", clab="Body Size", main="Reptilia")
.terntd <- filter(terntd, class=="Reptilia")
TernaryPoints(.terntd$dat[,5:7], pch=21, cex=0.35, bg=.terntd$dat$repmode+1, col=.terntd$dat$repmode+1)

Ternary::TernaryPlot(alab="Adult Mortality", blab="Juv Mortality", clab="Body Size", main="Aves")
.terntd <- filter(terntd, class=="Aves")
TernaryPoints(.terntd$dat[,5:7], pch=21, cex=0.35, bg=.terntd$dat$repmode+1, col=.terntd$dat$repmode+1)

Ternary::TernaryPlot(alab="Adult Mortality", blab="Juv Mortality", clab="Body Size", main="Amphibia")
.terntd <- filter(terntd, class=="Amphibia")
TernaryPoints(.terntd$dat[,5:7], pch=21, cex=0.35, bg=.terntd$dat$repmode+1, col=.terntd$dat$repmode+1)

Ternary::TernaryPlot(alab="Adult Mortality", blab="Juv Mortality", clab="Body Size", main="Actinopterygii")
.terntd <- filter(terntd, class=="Actinopterygii")
TernaryPoints(.terntd$dat[,5:7], pch=21, cex=0.35, bg=.terntd$dat$repmode+1, col=.terntd$dat$repmode+1)

Ternary::TernaryPlot(alab="Adult Mortality", blab="Juv Mortality", clab="Body Size", main="Mammalia")
.terntd <- filter(terntd, class=="Mammalia")
TernaryPoints(.terntd$dat[,5:7], pch=21, cex=0.35, bg=.terntd$dat$repmode+1, col=.terntd$dat$repmode+1)


Ternary::TernaryPlot(alab="Adult Mortality", blab="Juv Mortality", clab="Body Size", main="Not mammals or birds")
.terntd <- filter(terntd, !class %in% c("Mammalia", "Aves"))
TernaryPoints(.terntd$dat[,5:7], pch=21, cex=0.35, bg=.terntd$dat$repmode+1, col=.terntd$dat$repmode+1)


#plot(terntd$dat$trAdMort, terntd$dat$trJMort)


```

## Now fit to discrete ternary plot data
```{r}
library(Ternary)
library(MCMCpack)
library(combinat)
library(dplyr)

dat <- dplyr::select(terntd$dat, 5,6,7)

bins <- 3

combos <- combinat::combn(rep(1:bins,3), 3) ## Create all combinations of values 1:bins
sums <- apply(combos, 2, sum) #Sum the 3 values for the 3 traits
combos <- combos[,sums %in% c(bins+2, bins+1)] #Only retain those that sum to bins+2 and bins+1 (fit in the triangle)
cells <- t(combos[,!duplicated(apply(combos, 2,paste, collapse=""))]) #remove duplicated bin combinations
colnames(cells) <- c("A", "B", "C") #label traits
cells <- cells[order(cells[,3],(bins+1)-cells[,1],(bins+1)-cells[,2], decreasing=TRUE),] #reorder the cells to be prettier
cellnames <- apply(cells, 1, paste, collapse="") #Give the cells a state label  
ddat <- apply(dat, 2, cut,breaks=seq(0,1, length.out=bins+1), labels=1:bins) #Find where the data falls in the state space
ddat <- match(apply(ddat, 1, paste, collapse=""), cellnames) #match the data's state to the state label
terntd <- mutate(terntd, ddat=ddat) 


Ternary::TernaryPlot(alab="A", blab="B", clab="C", grid.lines = 3) #Plot with points labeled by their numeric state value (values with more than two digits won't show up right)
ssq <- seq(0, 1, length.out=bins+4)[c(2,4,6)]
midcells <- cbind(ssq[cells[,1]], ssq[cells[,2]], ssq[cells[,3]])
for(i in 1:nrow(midcells)){
  midcells[i,] <- midcells[i,]/sum(midcells[i,])
}
colnames(midcells) <- colnames(cells)
TernaryPoints(midcells, pch=as.character(1:9))
#TernaryPoints(dat, pch=as.character(ddat)) 

Q <- as.matrix(dist(cells))
Q[Q!=1] <- 0
Q
```

```{r}
library(castor)
.terntd <- filter(terntd, !is.na(ddat))
ERfit <- castor::fit_mk(.terntd$phy, 9, tip_states=.terntd[['ddat']], rate_model=Q)
ERfit


```

```{r}
## Viviparity
.terntd <- dplyr::mutate(.terntd, ddatpm = ddat+repmode*9) %>% filter(!class %in% c("Mammalia", "Aves"))
DM1 <- DM2 <- diag(9)
diag(DM1) <- 2
diag(DM2) <- 3

Qpm0.ER <- rbind(cbind(Q, DM1), cbind(DM1, Q))
Qpm0.Asym <- rbind(cbind(Q, DM1), cbind(DM2, Q))
rownames(Qpm0.ER) <- colnames(Qpm0.ER) <- 1:18
rownames(Qpm0.Asym) <- colnames(Qpm0.Asym) <- 1:18
Fit.pm0.ER <- castor::fit_mk(.terntd$phy, 18, tip_states=.terntd[['ddatpm']], rate_model=Qpm0.ER)
Fit.pm0.Asym <- castor::fit_mk(.terntd$phy, 18, tip_states=.terntd[['ddatpm']], rate_model=Qpm0.Asym)
Fit.pm0.ER
Fit.pm0.Asym

```


```{r}
Qpm1235.ER <- Qpm0.ER
Qpm1235.Asym <- Qpm0.Asym

pmRates <- cbind(c(1,2,3,5), c(1,2,3,5)+nrow(Q))
for(i in 1:nrow(pmRates)){
  Qpm1235.ER[pmRates[i,1], pmRates[i,2]]<- Qpm1235.ER[pmRates[i,2], pmRates[i,1]] <- max(Qpm0.ER)+1
}

pmRates <- cbind(c(1,2,3,5), c(1,2,3,5)+nrow(Q))
for(i in 1:nrow(pmRates)){
  Qpm1235.Asym[pmRates[i,1], pmRates[i,2]]<- max(Qpm0.Asym)+1
  Qpm1235.Asym[pmRates[i,2], pmRates[i,1]]<- max(Qpm0.Asym)+2
}



Qpm1235.ER
Qpm1235.Asym

Fit.pm1235.ER <- castor::fit_mk(.terntd$phy, 18, tip_states=.terntd[['ddatpm']], rate_model=Qpm1235.ER)
Fit.pm1235.Asym <- castor::fit_mk(.terntd$phy, 18, tip_states=.terntd[['ddatpm']], rate_model=Qpm1235.Asym)
Fit.pm1235.ER$loglikelihood
Fit.pm1235.Asym$loglikelihood

```

```{r}
DM3 <- DM4 <- diag(9)
diag(DM3) <- 1:9
diag(DM4) <- 10:18
Qpm.ARD <- rbind(cbind(Q, DM3), cbind(DM4,Q))
colnames(Qpm.ARD) <- rownames(Qpm.ARD) <- 1:18
Fit.pm.ARD <- castor::fit_mk(.terntd$phy, 18, tip_states=.terntd[['ddatpm']], rate_model=Qpm.ARD)

```



```{r}
cat("\nAIC ER no parity equal across regions\n")
2* max(Qpm0.ER) - 2*Fit.pm0.ER$loglikelihood
cat("\nAIC Asym no parity equal across regions\n")
2* max(Qpm0.Asym) - 2*Fit.pm0.Asym$loglikelihood
cat("\nAIC ER viviparous increased in 1235\n")
2* max(Qpm1235.ER) - 2*Fit.pm1235.ER$loglikelihood
cat("\nAIC Asym viviparous increased in 1235\n")
2* max(Qpm1235.Asym) - 2*Fit.pm1235.Asym$loglikelihood

```

```{r}

Ternary::TernaryPlot(alab="Adult Mortality", blab="Juv Mortality", clab="Body Size", main="Not mammals or birds", grid.lines = 3)
.terntd <- filter(terntd, !class %in% c("Mammalia", "Aves"))
TernaryPoints(.terntd$dat[,5:7], pch=21, cex=0.35, bg=.terntd$dat$repmode+1, col=.terntd$dat$repmode+1)
TernaryPoints(midcells, pch=as.character(1:9), col="red", cex=1.25)
```


#VIII. New hyp. framework: 

```{r}
library(phylolm)
rmtd <- filter(td, !is.na(repmode))#removing NAs
table(rmtd$dat$order)
rmtd <- mutate(rmtd, scjMort = scale(juvMort)[,1], scadMort = scale(adMort)[,1], lnLongevity=log(longevity), lnMass=log(mass), lnSVL =log(svl), lnSize=logMass3)
rmtd$dat$AdTerr[is.na(rmtd$dat$AdTerr) & rmtd$dat$order=="Squamata"] <- 1


```


```{r}
rmtd$dat$AdTerr[is.na(rmtd$dat$AdTerr) & rmtd$dat$order=="Squamata"] <- 1
rmMtd <- filter(rmtd, !is.na(adMort), !is.na(IF), !is.na(lnSize), !is.na(juvMort))
## Patches:
rmMtd$dat$AdTerr[rmMtd$dat$species=="Typhlonectes compressicauda"] <- 0
rmMtd$dat$repmode[rmMtd$dat$species=="Uromastyx acanthinura"] <- 0
rmMtd$dat$repmode[rmMtd$dat$species=="Pogona vitticeps"] <- 0


table(rmMtd$dat$order)
sum(table(rmMtd$dat$order))
rownames(rmMtd$dat) <- rmMtd$phy$tip.label
#glmfit <- phyloglm(repmode ~ scjMort*AdTerr + scadMort*AdTerr, data=rmMtd$dat, phy=rmMtd$phy, btol=20)
#glmfitstep <- phyloglmstep(repmode ~ scjMort*AdTerr*scadMort*IF, data=rmMtd$dat, phy=rmMtd$phy, btol=20)
#oglmfit <- glm(repmode ~ 1 + scjMort + scadMort + juvTerr + scjMort:juvTerr + scadMort:juvTerr, data=rmMtd$dat)
fitsjMort <- list()
fitsjMort[[1]] <- phylolm(scjMort ~ lnSize*Terr+ repmode+Terr, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")
fitsjMort[[2]] <- phylolm(scjMort ~ lnSize+ lnLongevity+ repmode + Terr, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")
fitsjMort[[3]] <- phylolm(scjMort ~ scadMort, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")
fitsjMort[[4]] <- phylolm(scjMort ~ IF, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")
fitsjMort[[5]] <- phylolm(scjMort ~ Terr, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")
fitsjMort[[6]] <- phylolm(scjMort ~ lnSize, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")
fitsjMort[[7]] <- phylolm(scjMort ~ lnSize*scadMort, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")

```


```{r}
lapply(fitsjMort, summary)
```


```{r}
rmtd$dat$AdTerr[is.na(rmtd$dat$AdTerr) & rmtd$dat$order=="Squamata"] <- 1
rmMtd <- filter(rmtd, !is.na(adMort), !is.na(IF), !is.na(lnSize), !is.na(juvMort))
## Patches:
rmMtd$dat$AdTerr[rmMtd$dat$species=="Typhlonectes compressicauda"] <- 0
rmMtd$dat$repmode[rmMtd$dat$species=="Uromastyx acanthinura"] <- 0
rmMtd$dat$repmode[rmMtd$dat$species=="Pogona vitticeps"] <- 0


table(rmMtd$dat$order)
sum(table(rmMtd$dat$order))
rownames(rmMtd$dat) <- rmMtd$phy$tip.label
#glmfit <- phyloglm(repmode ~ scjMort*AdTerr + scadMort*AdTerr, data=rmMtd$dat, phy=rmMtd$phy, btol=20)
#glmfitstep <- phyloglmstep(repmode ~ scjMort*AdTerr*scadMort*IF, data=rmMtd$dat, phy=rmMtd$phy, btol=20)
#oglmfit <- glm(repmode ~ 1 + scjMort + scadMort + juvTerr + scjMort:juvTerr + scadMort:juvTerr, data=rmMtd$dat)
fitsadMort <- list()
fitsadMort[[1]] <- phylolm(scadMort ~ lnSize*Terr+ repmode+Terr, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")
fitsadMort[[2]] <- phylolm(scadMort ~ lnSize+ lnLongevity+ repmode + Terr, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")
fitsadMort[[3]] <- phylolm(scadMort ~ scjMort, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")
fitsadMort[[4]] <- phylolm(scadMort ~ IF, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")
fitsadMort[[5]] <- phylolm(scadMort ~ Terr, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")
fitsadMort[[6]] <- phylolm(scadMort ~ lnSize, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")
fitsadMort[[7]] <- phylolm(scadMort ~ lnSize*scjMort, data=rmMtd$dat, phy=rmMtd$phy, model="lambda")
```

```{r}
lapply(fitsadMort, summary)
```

